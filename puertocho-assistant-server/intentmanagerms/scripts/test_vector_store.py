#!/usr/bin/env python3
"""
Script de prueba para VectorStoreService
Verifica que el vector store se carga correctamente y los endpoints funcionan
"""

import requests
import json
import time
import sys
import uuid
from typing import Dict, Any, List

class VectorStoreTester:
    def __init__(self, base_url: str = "http://localhost:9904"):
        self.base_url = base_url
        self.session = requests.Session()
        
    def test_health(self) -> bool:
        """Prueba el endpoint de health"""
        print("üîç Probando health check...")
        try:
            response = self.session.get(f"{self.base_url}/api/v1/vector-store/health")
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ Health: {data.get('status', 'UNKNOWN')}")
                return data.get('healthy', False)
            else:
                print(f"‚ùå Health check fall√≥: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error en health check: {e}")
            return False
    
    def test_statistics(self) -> bool:
        """Prueba el endpoint de estad√≠sticas"""
        print("üìä Probando estad√≠sticas...")
        try:
            response = self.session.get(f"{self.base_url}/api/v1/vector-store/statistics")
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ Estad√≠sticas cargadas:")
                print(f"   - Tipo: {data.get('type')}")
                print(f"   - Colecci√≥n: {data.get('collectionName')}")
                print(f"   - Dimensi√≥n: {data.get('embeddingDimension')}")
                print(f"   - Documentos: {data.get('totalDocuments')}")
                print(f"   - B√∫squedas: {data.get('totalSearches')}")
                print(f"   - Umbral: {data.get('similarityThreshold')}")
                return True
            else:
                print(f"‚ùå Estad√≠sticas fallaron: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error en estad√≠sticas: {e}")
            return False
    
    def test_info(self) -> bool:
        """Prueba el endpoint de informaci√≥n"""
        print("‚ÑπÔ∏è Probando informaci√≥n...")
        try:
            response = self.session.get(f"{self.base_url}/api/v1/vector-store/info")
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ Informaci√≥n obtenida:")
                print(f"   - Tipo: {data.get('type')}")
                print(f"   - Documentos: {data.get('totalDocuments')}")
                print(f"   - Saludable: {data.get('healthy')}")
                return True
            else:
                print(f"‚ùå Informaci√≥n fall√≥: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error en informaci√≥n: {e}")
            return False
    
    def test_add_document(self) -> str:
        """Prueba a√±adir un documento"""
        print("üìù Probando a√±adir documento...")
        try:
            # Crear documento de prueba
            doc_id = str(uuid.uuid4())
            document = {
                "id": doc_id,
                "content": "¬øqu√© tiempo hace hoy en Madrid?",
                "intent": "consultar_tiempo",
                "embedding": self.generate_mock_embedding("¬øqu√© tiempo hace hoy en Madrid?"),
                "metadata": {
                    "description": "Consulta meteorol√≥gica",
                    "language": "es",
                    "example_type": "test"
                }
            }
            
            response = self.session.post(
                f"{self.base_url}/api/v1/vector-store/documents",
                json=document
            )
            
            if response.status_code == 200:
                print(f"‚úÖ Documento a√±adido: {doc_id}")
                return doc_id
            else:
                print(f"‚ùå A√±adir documento fall√≥: {response.status_code}")
                return None
        except Exception as e:
            print(f"‚ùå Error a√±adiendo documento: {e}")
            return None
    
    def test_get_document(self, doc_id: str) -> bool:
        """Prueba obtener un documento"""
        print(f"üìñ Probando obtener documento: {doc_id}")
        try:
            response = self.session.get(f"{self.base_url}/api/v1/vector-store/documents/{doc_id}")
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ Documento obtenido:")
                print(f"   - ID: {data.get('id')}")
                print(f"   - Contenido: {data.get('content')}")
                print(f"   - Intenci√≥n: {data.get('intent')}")
                return True
            else:
                print(f"‚ùå Obtener documento fall√≥: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error obteniendo documento: {e}")
            return False
    
    def test_search_by_text(self) -> bool:
        """Prueba b√∫squeda por texto"""
        print("üîç Probando b√∫squeda por texto...")
        try:
            query = "¬øc√≥mo est√° el clima?"
            response = self.session.post(
                f"{self.base_url}/api/v1/vector-store/search/text",
                params={"query": query, "limit": 3}
            )
            
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ B√∫squeda completada:")
                print(f"   - Consulta: {data.get('query')}")
                print(f"   - Resultados: {data.get('totalResults')}")
                print(f"   - Tiempo: {data.get('searchTimeMs')}ms")
                
                if data.get('documents'):
                    best_match = data['documents'][0]
                    print(f"   - Mejor coincidencia: {best_match.get('content')}")
                    print(f"   - Similitud: {best_match.get('similarity', 0):.3f}")
                
                return True
            else:
                print(f"‚ùå B√∫squeda fall√≥: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error en b√∫squeda: {e}")
            return False
    
    def test_search_by_embedding(self) -> bool:
        """Prueba b√∫squeda por embedding"""
        print("üîç Probando b√∫squeda por embedding...")
        try:
            query = "enciende la luz del sal√≥n"
            embedding = self.generate_mock_embedding(query)
            
            response = self.session.post(
                f"{self.base_url}/api/v1/vector-store/search",
                params={"query": query, "limit": 3},
                json=embedding
            )
            
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ B√∫squeda por embedding completada:")
                print(f"   - Consulta: {data.get('query')}")
                print(f"   - Resultados: {data.get('totalResults')}")
                print(f"   - Tiempo: {data.get('searchTimeMs')}ms")
                
                if data.get('documents'):
                    best_match = data['documents'][0]
                    print(f"   - Mejor coincidencia: {best_match.get('content')}")
                    print(f"   - Similitud: {best_match.get('similarity', 0):.3f}")
                
                return True
            else:
                print(f"‚ùå B√∫squeda por embedding fall√≥: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error en b√∫squeda por embedding: {e}")
            return False
    
    def test_delete_document(self, doc_id: str) -> bool:
        """Prueba eliminar un documento"""
        print(f"üóëÔ∏è Probando eliminar documento: {doc_id}")
        try:
            response = self.session.delete(f"{self.base_url}/api/v1/vector-store/documents/{doc_id}")
            if response.status_code == 200:
                print(f"‚úÖ Documento eliminado: {doc_id}")
                return True
            else:
                print(f"‚ùå Eliminar documento fall√≥: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error eliminando documento: {e}")
            return False
    
    def test_clear_all(self) -> bool:
        """Prueba limpiar todos los documentos"""
        print("üßπ Probando limpiar todos los documentos...")
        try:
            response = self.session.delete(f"{self.base_url}/api/v1/vector-store/documents")
            if response.status_code == 200:
                print("‚úÖ Todos los documentos eliminados")
                return True
            else:
                print(f"‚ùå Limpiar documentos fall√≥: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Error limpiando documentos: {e}")
            return False
    
    def test_multiple_documents(self) -> bool:
        """Prueba a√±adir m√∫ltiples documentos"""
        print("üìö Probando a√±adir m√∫ltiples documentos...")
        try:
            documents = [
                {
                    "id": str(uuid.uuid4()),
                    "content": "programa una alarma para ma√±ana a las 8",
                    "intent": "programar_alarma",
                    "embedding": self.generate_mock_embedding("programa una alarma para ma√±ana a las 8"),
                    "metadata": {"language": "es", "example_type": "test"}
                },
                {
                    "id": str(uuid.uuid4()),
                    "content": "reproduce m√∫sica relajante",
                    "intent": "reproducir_musica",
                    "embedding": self.generate_mock_embedding("reproduce m√∫sica relajante"),
                    "metadata": {"language": "es", "example_type": "test"}
                },
                {
                    "id": str(uuid.uuid4()),
                    "content": "apaga todas las luces",
                    "intent": "apagar_luz",
                    "embedding": self.generate_mock_embedding("apaga todas las luces"),
                    "metadata": {"language": "es", "example_type": "test"}
                }
            ]
            
            added_count = 0
            for doc in documents:
                response = self.session.post(
                    f"{self.base_url}/api/v1/vector-store/documents",
                    json=doc
                )
                if response.status_code == 200:
                    added_count += 1
            
            print(f"‚úÖ {added_count}/{len(documents)} documentos a√±adidos")
            return added_count == len(documents)
        except Exception as e:
            print(f"‚ùå Error a√±adiendo m√∫ltiples documentos: {e}")
            return False
    
    def test_similarity_search(self) -> bool:
        """Prueba b√∫squeda de similitud con diferentes consultas"""
        print("üéØ Probando b√∫squeda de similitud...")
        try:
            test_queries = [
                "¬øqu√© tiempo hace?",
                "enciende la luz",
                "pon una alarma",
                "reproduce m√∫sica"
            ]
            
            for query in test_queries:
                print(f"   Probando: '{query}'")
                response = self.session.post(
                    f"{self.base_url}/api/v1/vector-store/search/text",
                    params={"query": query, "limit": 2}
                )
                
                if response.status_code == 200:
                    data = response.json()
                    if data.get('documents'):
                        best_match = data['documents'][0]
                        print(f"     ‚úÖ Mejor: {best_match.get('content')} (sim: {best_match.get('similarity', 0):.3f})")
                    else:
                        print(f"     ‚ö†Ô∏è Sin resultados")
                else:
                    print(f"     ‚ùå Error: {response.status_code}")
            
            return True
        except Exception as e:
            print(f"‚ùå Error en b√∫squeda de similitud: {e}")
            return False
    
    def generate_mock_embedding(self, content: str) -> List[float]:
        """Genera un embedding simulado para testing"""
        import math
        
        embedding = []
        hash_val = hash(content)
        
        for i in range(1536):
            value = math.sin(hash_val + i * 0.1) * 0.5
            embedding.append(float(value))
        
        return embedding
    
    def run_all_tests(self) -> bool:
        """Ejecuta todas las pruebas"""
        print("üöÄ Iniciando pruebas de VectorStoreService")
        print("=" * 50)
        
        tests = [
            ("Health Check", self.test_health),
            ("Statistics", self.test_statistics),
            ("Info", self.test_info),
            ("Add Document", lambda: self.test_add_document()),
            ("Get Document", lambda: self.test_get_document(self.test_add_document())),
            ("Search by Text", self.test_search_by_text),
            ("Search by Embedding", self.test_search_by_embedding),
            ("Multiple Documents", self.test_multiple_documents),
            ("Similarity Search", self.test_similarity_search),
            ("Delete Document", lambda: self.test_delete_document(self.test_add_document())),
            ("Clear All", self.test_clear_all),
        ]
        
        passed = 0
        total = len(tests)
        
        for test_name, test_func in tests:
            print(f"\nüß™ {test_name}")
            print("-" * 30)
            
            try:
                if test_func():
                    passed += 1
                    print(f"‚úÖ {test_name} - PAS√ì")
                else:
                    print(f"‚ùå {test_name} - FALL√ì")
            except Exception as e:
                print(f"‚ùå {test_name} - ERROR: {e}")
            
            time.sleep(0.5)  # Peque√±a pausa entre pruebas
        
        print("\n" + "=" * 50)
        print(f"üìä Resultados: {passed}/{total} pruebas pasaron")
        
        if passed == total:
            print("üéâ ¬°Todas las pruebas pasaron exitosamente!")
            return True
        else:
            print("‚ö†Ô∏è  Algunas pruebas fallaron")
            return False

def main():
    """Funci√≥n principal"""
    if len(sys.argv) > 1:
        base_url = sys.argv[1]
    else:
        base_url = "http://localhost:9904"
    
    print(f"üéØ Probando VectorStoreService en: {base_url}")
    
    tester = VectorStoreTester(base_url)
    success = tester.run_all_tests()
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main() 